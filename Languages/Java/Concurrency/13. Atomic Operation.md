## ğŸ“˜ Atomic Operationì˜ íŒë‹¨ ê¸°ì¤€

ì›ìì ì¸ ì—°ì‚°(Atomic Operation)ì„ íŒë‹¨í•˜ëŠ” ê¸°ì¤€ì´ ë­˜ê¹Œìš”?

ì „ ê¸€ì—ì„œ ì˜ˆì‹œë¥¼ ë“¤ë©° í•™ìŠµ í–ˆì—ˆì§€ë§Œ ì•„ì§ í¬ê²Œ ì™€ ë‹¿ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.

<br>

ê·¸ë˜ì„œ ì–´ë–¤ ì—°ì‚°ì§€ ì›ìì ì¸ì§€ ëª¨ë¥´ë‹ˆê¹Œ ëª¨ë“  í•¨ìˆ˜ë¥¼ synchronizedë¥¼ ì´ìš©í•´ ë™ê¸°í™” í•œë‹¤ê³  ê°€ì •í•´ë´…ë‹ˆë‹¤.

ì¦‰, ê³µìœ  ë³€ìˆ˜ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ëª¨ë“  í•¨ìˆ˜ë¥¼ ë™ê¸°í™” ì‹œí‚µë‹ˆë‹¤.

ê·¸ëŸ¼ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì˜ ê°œìˆ˜ë¥¼ ìµœì†Œí™” í•´ì£¼ê²Œ ë˜ëŠ”ë°ìš”.

<br>

ì˜ˆë¥¼ ë“¤ì–´ ë™ì‹œ ì‹¤í–‰ ë  ê±°ë¼ ì§ì‘í•˜ëŠ” ìŠ¤ë ˆë“œë¥¼ 4ê°œ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•˜ë©´,

ëª¨ë“  í•¨ìˆ˜ê°€ ë™ê¸°í™” ëœ ìƒíƒœë¼ í•œë²ˆì— 1ê°œì˜ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰ ë˜ê³  ë‚˜ë¨¸ì§€ 3ê°œëŠ” Suspend ìƒíƒœë¡œ ìˆê²Œ ë©ë‹ˆë‹¤.

ì´ëŸ¬ë©´ ì‚¬ì‹¤ìƒ ìŠ¤ë ˆë“œ 1ê°œë§Œ ìˆëŠ”ê²ƒê³¼ ë‹¤ë¥¼ê²Œ ì—†ìŠµë‹ˆë‹¤.

<br>

ë” ì•ˆ ì¢‹ì€ ì ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ & ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œê¹Œì§€ ë°œìƒí•´

ì˜¤íˆë ¤ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒ ë³´ë‹¤ í›¨ì”¬ ì¢‹ì§€ ì•Šì€ ì„±ëŠ¥ì„ ê°€ì§€ê²Œ ë©ë‹ˆë‹¤.

<br>

ì œê°€ ì›í•˜ëŠ” ë°©í–¥ì€ ëŒ€ë¶€ë¶„ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œ ì‹¤í–‰ë˜ë©´ì„œ ì •í•´ì§„ ì‹œê°„ì— ìŠ¤ë ˆë“œ í•˜ë‚˜ë§Œ ì‹¤í–‰ë  ë•Œë³´ë‹¤,

ë” ë§ì€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ë°©í–¥ì…ë‹ˆë‹¤.

í•µì‹¬ë§Œ ë§í•˜ë©´ í•¨ìˆ˜ë¥¼ ë™ê¸°í™” í• ë–„ **ë™ê¸°í™” í•˜ëŠ” ë¶€ë¶„ì„ ìµœì†Œí™”**í•´ì•¼ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.

<br>

> ğŸš© **ì–´ë–¤ ì—°ì‚°ì§€ ì›ìì ì¸ì§€ì— ëŒ€í•œ íŒë‹¨**

**Reference í• ë‹¹**

- ëª¨ë“  Reference í• ë‹¹ì€ Atomic Operation(ì›ìì  ì—°ì‚°)ì…ë‹ˆë‹¤.
- ì¦‰, ì°¸ì¡°ë¥¼ í•˜ëŠ” ê°ì²´ëŠ” ë‹¨ì¼ ì—°ì‚°ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´ Referenceë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ë°°ì—´,ë¬¸ìì—´ ë“± ê°ì²´ì— ì„¤ì •í•˜ëŠ” ì‘ì—…ì¸ Getter / Setterê°€ ì›ìì  ì—°ì‚°ì˜ ëŒ€í‘œì ì¸ ì˜ˆì…ë‹ˆë‹¤.
- ìœ„ Getter / Setterì˜ ê²½ìš° ë™ê¸°í™”ë¥¼ ì‹œí‚¬ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

<br>

**long & doubleì„ ì œì™¸í•œ ì›ì‹œí˜•ì— ëŒ€í•œ ëª¨ë“  í• ë‹¹**

- ì´ ê²½ìš°ë„ Atomic Operationì— í•´ë‹¹í•©ë‹ˆë‹¤.
- ìœ„ ì›ì‹œí˜• íƒ€ì… ì™¸ **int,short,byte,float,char,boolean** ëª¨ë‘ ë™ê¸°í™” í•  í•„ìš” ì—†ì´ ì•ˆì „í•˜ê²Œ Read / Writeê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

<br>

> ğŸš© **long / doubleì´ Atomic Operationì´ ì•„ë‹Œ ì´ìœ **

- longê³¼ doubleì€ ê¸¸ì´ê°€ 64ë¹„íŠ¸ì—¬ì„œ Javaì—ì„œ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥ í•´ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
- 64ë¹„íŠ¸ ê¸°ë°˜ ì»´í“¨í„°ì˜ ê²½ìš°ì—ë„ longì´ë‚˜ doubleì— Write ì‘ì—…ì„ í•˜ë©´ ì‹¤ì œë¡œ CPU 2ê°œë¥¼ ì‚¬ìš©í•´ ì—°ì‚°ì„ í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

<br>

ìœ„ì˜ ì´ìœ ë¡œ long / double ì„ ì‚¬ìš©í•  ë•Œ `volatile` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ë³€ìˆ˜ì˜ Read / Write ì‘ì—…ì´,

Thread Safeí•œ ì›ìì  ì—°ì‚°ì„ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤.

ë‚´ë¶€ì ìœ¼ë¡œ ë³´ë©´ 2ê°œì˜ í•˜ë“œì›¨ì–´ ì—°ì‚°ì´ ì•„ë‹Œ, 1ê°œì˜ í•˜ë“œì›¨ì–´ ì—°ì‚°ìœ¼ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ê±¸ ë³´ì¥í•©ë‹ˆë‹¤.

---

## ğŸ“˜ Use Case - Metrics Capturing

ì–´í”Œë¦¬ì¼€ì´ì…˜ ì œì‘ ë‹¨ê³„ì—ì„œ ì•±ì„ ì‹¤í–‰í•  ë•Œ

ì¤‘ìš”í•œ ì—°ì‚°ì´ë‚˜ ì½”ë“œ ì‘ì—… ì‹œê°„ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ëŠ”ì§€ ì¸¡ì •í•˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.

```java
public class SomeBusinessLogicClass {
    public void time() {
        long start = System.currentTimeMillis();
        // Important Operation
        long end = System.currentTimeMillis();

        long duration = end - start;
        captureMetrics(duration);
    }
}
```

ì´ëŸ° ì‘ì—…ì˜ ì†Œìš” ì‹œê°„ì€ í´ë¼ì´ì–¸íŠ¸ì˜ ì…ë ¥ê°’ ë°ì´í„°ì™€ ì½”ë“œê°€ ì‹¤í–‰ë˜ëŠ” HW, OS í™˜ê²½ ë“± ì—¬ëŸ¬ ìš”ì¸ì— ì˜í•´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.

í•´ë‹¹ ì—°ì‚°ë“¤ì˜ Durationì„ ì˜ ìº¡ì³í•´ì„œ ì„±ëŠ¥ ë¬¸ì œë¥¼ ì°¾ì•„ë‚´ì•¼ í•©ë‹ˆë‹¤.

<br>

> ğŸš© **ìŠ¤ë ˆë“œì˜ ìˆ˜í–‰ ì‹œê°„(Duration)ì„ ìº¡ì³í•˜ëŠ” ê°„ë‹¨í•œ í”„ë¡œê·¸ë¨ ì˜ˆì‹œ**

ì•„ë˜ ì½”ë“œì—ì„œ ëˆˆì—¬ê²¨ ë´ì•¼í•  ê±´ Metrics í´ë˜ìŠ¤ì˜ `average` ë³€ìˆ˜ ì˜†ì— ë¶™ì€ `volatile` í‚¤ì›Œë“œì™€,

ë°”ë¡œ ì•„ë˜ `synchronized` í‚¤ì›Œë“œê°€ ì ìš©ëœ ë™ê¸°í™” í•¨ìˆ˜ì…ë‹ˆë‹¤.

<br>

ìš°ì„  **ë™ê¸°í™”ëœ appSample í•¨ìˆ˜**ëŠ” ì½”ë“œ ìì²´ê°€ synchronizedê°€ ì—†ìœ¼ë©´,

ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— averageì™€ countë¥¼ ìˆ˜ì •í• ë•Œ ë°ì´í„°ì˜ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ê¸° í˜ë“¤ê²Œ ë•Œë¬¸ì— ë™ê¸°í™” ì‹œì¼œ ì£¼ì—ˆìŠµë‹ˆë‹¤.

<br>

ê·¸ë¦¬ê³  Metrics í´ë˜ìŠ¤ì˜ average ë³€ìˆ˜ì— ë¶™ì€ `volatile` í‚¤ì›Œë“œë¥¼ ë¶™ì¸ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- ë‹¨ìˆœíˆ ì™¸ë¶€ì—ì„œ Getterë¥¼ ì“¸ë•Œ Reference & Primitive íƒ€ì…ì˜ Read ì‘ì—…ì€ ë™ê¸°í™”ê°€ í•„ìš”ì—†ìŠµë‹ˆë‹¤.
- í•˜ì§€ë§Œ, double í˜•ì€ Thread-Safeí•œ ë‹¤ë¥¸ Primitive í˜•ê³¼ ë‹¬ë¦¬ long, doubleì€ Thread-Safe ë³´ì¥ì´ ì•ˆë©ë‹ˆë‹¤.
- ê·¸ë˜ì„œ `volatile` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ë³€ìˆ˜ë¥¼ ë©”ì¸ ë©”ëª¨ë¦¬ì— ì§ì ‘ ì €ì¥í•˜ê³  ì½ì„ë–„ë„ ë©”ì¸ ë©”ëª¨ë¦¬ì—ì„œ ì½ë„ë¡ ë³´ì¥í•´ì£¼ëŠ” í‚¤ì›Œë“œì…ë‹ˆë‹¤.
- ì¦‰, ë©”ì¸ ë©”ëª¨ë¦¬ì—ì„œ ê°’ì„ ì½ê³  ì”€ìœ¼ë¡œì¨ í•­ìƒ ìµœì‹ ì˜ ê°’ì„ ë³´ì¥í•˜ì—¬ ê°€ì‹œì„± ë¬¸ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

```java
@Slf4j  
public class TimeAverage {  
    public static void main(String[] args) {  
        Metrics metrics = new Metrics();  
  
        BusinessLogic business1 = new BusinessLogic(metrics);  
        BusinessLogic business2 = new BusinessLogic(metrics);  
        MetricsPrinter printer = new MetricsPrinter(metrics);  
  
        business1.start();  
        business2.start();  
        printer.start();  
    }  
  
    /* ìƒ˜í”Œì˜ í‰ê· ê°’ì„ ê°€ì§€ê³  ìˆëŠ” í´ë˜ìŠ¤ */    
    @Getter  
    public static class Metrics {  
        private long count = 0; // ì§€ê¸ˆê¹Œì§€ ìº¡ì³ëœ ìƒ˜í”Œì˜ ê°œìˆ˜ë¥¼ ì¶”ì í•˜ëŠ” Count ë³€ìˆ˜  
        private volatile double average = 0.0; // ëª¨ë“  ìƒ˜í”Œì˜ ì´í•©ì„ ê°œìˆ˜ë¡œ ë‚˜ëˆˆ í‰ê· ê°’  
  
        // ìƒˆë¡œìš´ Sample ê°’ì„ ë°›ì•„ ìƒˆë¡œìš´ í‰ê· ê°’ì„ ì—…ë°ì´íŠ¸ í•´ì£¼ëŠ” í•¨ìˆ˜  
        public synchronized void addSample(long sample) {  
            double currentSum = average * count; // ê¸°ì¡´ í‰ê· ê°’  
            count++;  
            average = (currentSum + sample) / count; // ìƒˆë¡œìš´ í‰ê· ê°’  
        }  
    }  
  
    /* ì‹œì‘ & ì¢…ë£Œ ì‹œê°„ì„ ìº¡ì³í•´ ìƒ˜í”Œì„ ì¶”ê°€í•˜ëŠ” í´ë˜ìŠ¤ */    
    @RequiredArgsConstructor  
    public static class BusinessLogic extends Thread {  
        private final Metrics metrics;  
        private Random random = new Random();  
  
        @Override  
        public void run() {  
  
            while (true) {  
                long start = System.currentTimeMillis();  
  
                try {  
                    Thread.sleep(random.nextInt(10));  
                } catch (InterruptedException e) {  
                    log.error("Thread Interrupted");  
                }  
  
                long end = System.currentTimeMillis();  
  
                metrics.addSample(end - start);  
            }  
        }  
    }  
  
    /* BusinessLogic í´ë˜ìŠ¤ì™€ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ë©° BusinessLogicì˜ í‰ê·  ì‹œê°„ì„ ìº¡ì³ í›„ ì¶œë ¥í•˜ëŠ” í´ë˜ìŠ¤ */ 
    @RequiredArgsConstructor  
    public static class MetricsPrinter extends Thread {  
        private final Metrics metrics;  
  
        @Override  
        public void run() {  
            while (true) {  
                try {  
                    Thread.sleep(100);  
                } catch (InterruptedException e) {  
                    log.error("Thread Interrupted");  
                }  
  
                double currentAverage = metrics.getAverage();  
  
                log.info("í˜„ì¬ Average ê°’ : {}", currentAverage);  
            }  
        }  
    }  
}
```

<br>

**ì¶œë ¥ê°’**

```
22:42:31.171 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 4.975
22:42:31.277 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.012195121951219
22:42:31.377 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.049586776859504
22:42:31.478 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.100628930817612
22:42:31.578 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.1794871794871815
22:42:31.679 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.413333333333336
22:42:31.779 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.42145593869732
22:42:31.880 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.427609427609432
22:42:31.980 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.42388059701493
22:42:32.081 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.448648648648649
22:42:32.182 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.463054187192118
22:42:32.286 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.37250554323725
22:42:32.386 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.3117408906882595
22:42:32.487 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.333333333333331
22:42:32.588 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.319298245614034
22:42:32.689 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.263843648208466
22:42:32.789 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.315789473684206
22:42:32.890 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.338235294117644
22:42:32.991 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.393258426966289
22:42:33.092 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.422818791946306
22:42:33.192 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.432778489116517
22:42:33.293 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.427350427350428
22:42:33.394 [Thread-2] INFO com.thread.share.TimeAverage -- í˜„ì¬ Average ê°’ : 5.442488262910798
```

---
## ğŸ“˜ Summary

ìœ„ ì½”ë“œë¥¼ í† ëŒ€ë¡œ ì–´ë–¤ ì—°ì‚°ì´ ë™ê¸°í™” ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ìˆ˜í–‰ë  ìˆ˜ ìˆëŠ”ì§€, ì›ìì  ì—°ì‚°ì¸ì§€ì— ëŒ€í•´ ì¢€ ë” ì•Œì•„ ë³´ì•˜ìŠµë‹ˆë‹¤.

ìœ„ ì‘ì—…ì€ double / longì„ ì œì™¸í•œ Primitive Typeì— ëŒ€í•œ í• ë‹¹ ì‘ì—…ê³¼ Referenceì— ëŒ€í•œ í• ë‹¹ ì‘ì—…,

volatile í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•œ double / longì— ëŒ€í•œ í• ë‹¹ ì‘ì—… êµ¬ë³„í•  ìˆ˜ ìˆëŠ” ì˜ˆì‹œ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

<br>

ì›ìì  ì—°ì‚°ì— ëŒ€í•œ íŒë‹¨ì€ ë©€í‹°ìŠ¤ë ˆë”© í™˜ê²½ì—ì„œ ìˆ˜ ë§ì€ ì‘ì—…ì„ ë³‘ë ¬ ì‹¤í–‰í•˜ë©´ì„œ,

ì •í™•í•œ ê²°ê³¼ê°’ì„ ë„ì¶œí•  ìˆ˜ ìˆê³  ê³ ì„±ëŠ¥ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì¶•í•˜ëŠ”ë° ìˆì–´ í•µì‹¬ì…ë‹ˆë‹¤.

<br>

> ğŸš© **í•™ìŠµí•œ ì **

- volatile ë³€ìˆ˜ëŠ” ë³€ìˆ˜ì˜ ê°’ì„ í•­ìƒ ë©”ì¸ ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ ì½íˆë„ë¡ í•œë‹¤.
- volatile ë³€ìˆ˜ì— ìƒˆ ê°’ì´ ëŒ€ì…ë˜ë©´ ì´ ê°’ì€ ì–¸ì œë‚˜ ë©”ì¸ ë©”ëª¨ë¦¬ë¡œ ì¦‰ì‹œ ì“°ì—¬ì§„ë‹¤.
- ì´ ë™ì‘ì€ ë‹¤ë¥¸ CPU ì—ì„œ ë™ì‘í•˜ëŠ” ë‹¤ë¥¸ ì“°ë ˆë“œì—ê²Œ í•­ìƒ volatile ë³€ìˆ˜ì˜ ìµœì‹  ê°’ì´ ì½íˆë„ë¡ ë³´ì¥í•œë‹¤.Â 
- volatile ë³€ìˆ˜ì˜ ê°’ì€Â CPU ìºì‹œê°€ ì•„ë‹Œ ë©”ì¸ ë©”ëª¨ë¦¬ë¡œë¶€í„° ì§ì ‘ ì½íˆê²Œ ëœë‹¤.
- volatile ë³€ìˆ˜ëŠ” ë…¼ ë¸”ë¡œí‚¹ì´ë‹¤.
- volatile ë³€ìˆ˜ë¡œì˜ ì“°ê¸°ëŠ” ì›ìì  ì—°ì‚°ì´ê³ , ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ë¼ì–´ë“¤ ìˆ˜ ì—†ë‹¤.
- í•˜ì§€ë§Œ volatile ë³€ìˆ˜ë¼ í• ì§€ë¼ë„ ì—°ì†ì ì¸ ì½ê¸°-ê°’ ë³€ê²½-ì“°ê¸° ë™ì‘ì€ ì›ìì ì´ì§€ ì•Šë‹¤.
- ë‘˜ ì´ìƒì˜ ì“°ë ˆë“œì— ì˜í•´ ìˆ˜í–‰ëœë‹¤ë©´ ì—¬ì „íˆ ê²½í•©ì„ ìœ ë°œí•œë‹¤

<br>


volatileì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒì— ë” ìì„¸íˆ ë‹¤ë¤„ë³¼ ì˜ˆì •ì…ë‹ˆë‹¤.